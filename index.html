<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>mml-emitter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.4.0/codemirror.min.css">
    <style type="text/css">
      body { background: #ecf0f1 }
      .btn { margin-top: 10px; width: 100px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="title">mml-emitter</h1>
      <p>mml-emitter is a MML(Music Macro Language) event sequencer based on Web Audio API.</p>
      <div id="app">
        <div class="row">
          <div class="col-md-9">
            <div id="editor"></div>
            <div class="form-group">
              <div class="btn btn-default" v-on="click: isPlaying ? stop() : start()">{{ isPlaying ? 'Stop' : 'Start' }}</div>
            </div>
            <pre><code>function noteEventHandler(e) {
  var osc = audioContext.createOscillator();
  var amp = audioContext.createGain();
  var playbackTime = e.playbackTime;

  osc.frequency.value = e.frequency;
  osc.type = this.wave || "triangle";
  amp.gain.setValueAtTime(0.25 * (e.volume / 16), playbackTime);
  amp.gain.linearRampToValueAtTime(0.00, playbackTime + e.duration);

  osc.start(playbackTime);
  osc.connect(amp);
  amp.connect(audioContext.destination);

  e.noteOff(function() {
    amp.disconnect();
  });
}</code></pre>
          </div>
          <div class="col-md-3">
            <h4>Examples</h4>
            <ul>
              <li v-repeat="examples"><a href="#gistid:{{ gistid }}:{{ encodeURIComponent(title) }}">{{ title }}</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <a href="https://github.com/mohayonao/mml-emitter">
      <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png">
    </a>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/vue/0.10.5/vue.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.4.0/codemirror.min.js"></script>
    <script src="build/mml-emitter.min.js"></script>
    <script>
    var AudioContext = window.AudioContext || window.webkitAudioContext;
    $(function() {
      "use strict";

      var mml = null;
      var audioContext = new AudioContext();
      var editor = CodeMirror(document.getElementById("editor"), {
        lineNumbers: true,
      });
      var $title = $("#title");

      var vue = new Vue({
        el: "#app",
        data: {
          isPlaying: false,
          message: "",
          examples: []
        },
        computed: {
          mml: {
            $get: function() {
              return editor.getValue();
            },
            $set: function(value) {
              editor.setValue(value);
            }
          }
        },
        methods: {
          start: function() {
            if (mml) {
              mml.stop();
            }

            mml = new MMLEmitter(audioContext, this.mml);

            mml.blink = function(color) {
              $title.css("color", color);
            };

            if (mml) {
              this.message = "";

              mml.tracks.forEach(function(track) {
                track.on("note", noteEventHandler);
              });
              mml.on("end", function() {
                vue.stop();
              });
              mml.start();

              this.isPlaying = true;
            }
          },
          stop: function() {
            if (mml) {
              mml.stop();
            }
            $title.css("color", "inherit");
            this.isPlaying = false;
          },
          encodeURIComponent: window.encodeURIComponent
        }
      });

      function noteEventHandler(e) {
        var osc = audioContext.createOscillator();
        var amp = audioContext.createGain();
        var playbackTime = e.playbackTime;

        osc.frequency.value = e.frequency;
        osc.type = this.wave || "triangle";
        amp.gain.setValueAtTime(0.25 * (e.volume / 16), playbackTime);
        amp.gain.linearRampToValueAtTime(0.00, playbackTime + e.duration);

        osc.start(playbackTime);
        osc.connect(amp);
        amp.connect(audioContext.destination);

        e.noteOff(function() {
          amp.disconnect();
        });

        console.log(e);
      }

      function readFromGist(gistid, callback) {
        var url = "https://api.github.com/gists/" + gistid;
        $.ajax({ url: url, type: "GET", dataType: "jsonp" }).then(function(result) {
          if (result.data.files) {
            callback(result.data.files);
          } else {
            console.warn("gist:" + gistid + " not found");
          }
        });
      }

      function selectExample(title, examples) {
        examples = examples || vue.examples;
        vue.mml = (_.find(examples, function(example) {
          return example.title === title;
        }) || {}).source || "";
      }

      function updateExamples(gistid, title) {
        readFromGist(gistid, function(files) {
          var examples = _.chain(files).filter(function(file) {
            return /^(.+)\.mml$/.test(file.filename);
          }).map(function(file) {
            return {
              title : file.filename.match(/^(.+)\.mml$/)[1],
              source: file.content,
              gistid: gistid
            };
          }).value();

          vue.examples = _.filter(examples, function(example) {
            return example.title !== "default";
          });

          selectExample(title, examples);
        });
      }

      var prevGistId = "";

      window.onhashchange = function() {
        var matched = /^#gistid:([a-f\d]+)(?::(.+))?$/.exec(location.hash);
        if (matched) {
          matched[2] = decodeURIComponent(matched[2] || "default");

          if (prevGistId !== matched[1]) {
            prevGistId = matched[1];
            updateExamples(matched[1], matched[2]);
          } else {
            selectExample(matched[2]);
          }
        }
      };

      if (location.hash) {
        window.onhashchange();
      } else {
        window.location.replace("#gistid:434a459011acc3402b9b");
      }
    });
    </script>
  </body>
</html>
